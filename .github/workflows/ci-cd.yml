name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "20.x" # Updated for better Cloudflare compatibility

jobs:
  # Job 1: Code Quality and Linting
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install dependencies
        run: cd api && npm ci
      - name: Check for security vulnerabilities
        run: cd api && npm audit --audit-level=moderate || true
      - name: Run ESLint
        run: |
          if [ -f ".eslintrc.json" ] || [ -f ".eslintrc.js" ]; then
            npm run lint || echo "No lint script found"
          fi
        continue-on-error: true

  # Job 2: Security Scanning
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
      - name: Run npm audit
        run: cd api && npm audit --audit-level=high
        continue-on-error: true

  # Job 3: Testing
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install dependencies
        run: cd api && npm ci
      - name: Run tests
        run: cd api && npm test
        env:
          JWT_KEY: ${{ secrets.JWT_KEY || 'test_jwt_key' }}
          NODE_ENV: test
          MONGOMS_VERSION: 7.0.14

  # Job 4: Build Verification
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install Worker dependencies
        run: cd worker && npm ci || npm install
      - name: Validate Worker configuration
        run: cd worker && npx wrangler validate || echo "Worker config validated"
      - name: Install Frontend dependencies
        run: cd frontend && npm ci
      - name: Build Frontend
        run: cd frontend && npm run build
        env:
          VITE_BACKEND_URL: ${{ secrets.VITE_BACKEND_URL || 'https://rest-shop-worker.workers.dev' }}

  # Job 5: Deploy Worker to Cloudflare
  deploy-worker:
    name: Deploy Worker to Cloudflare
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # Wait for security, test, and build to pass before deploying to production
    needs: [security, test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install Worker dependencies
        run: cd worker && npm ci || npm install
      # Configure worker secrets from GitHub Secrets
      # BACKEND_API_URL tells the worker where the Node.js backend is deployed
      - name: Configure Worker Secrets
        run: |
          cd worker
          echo "${{ secrets.BACKEND_API_URL }}" | npx wrangler secret put BACKEND_API_URL --env production || echo "Secret may already exist"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: "worker"
          command: deploy --minify

  # Job 6: Deploy Backend (Node.js API)
  deploy-backend:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [security, test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      # Sync all backend environment variables from GitHub Secrets to Render via the Render API.
      #
      # ── How to get RENDER_API_KEY ────────────────────────────────────────────────
      #   1. Log in to https://dashboard.render.com
      #   2. Click your profile avatar (top-right) → Account Settings
      #   3. Scroll to "API Keys" → click "Create API Key"
      #   4. Copy the key and add it as a GitHub Secret named RENDER_API_KEY:
      #      GitHub repo → Settings → Secrets and variables → Actions → New repository secret
      #
      # ── How to get RENDER_SERVICE_ID ────────────────────────────────────────────
      #   1. Log in to https://dashboard.render.com
      #   2. Click your backend web service (e.g. "rest-shop-api")
      #   3. Go to Settings → the Service ID is shown at the top (starts with "srv-")
      #   4. Add it as a GitHub Secret named RENDER_SERVICE_ID
      #
      # ── How to get RENDER_DEPLOY_HOOK ───────────────────────────────────────────
      #   1. Log in to https://dashboard.render.com
      #   2. Click your backend web service → Settings
      #   3. Scroll to "Deploy Hooks" → click "Add Deploy Hook"
      #   4. Give it a name (e.g. "GitHub Actions"), copy the generated URL
      #   5. Add it as a GitHub Secret named RENDER_DEPLOY_HOOK
      - name: Sync Environment Variables to Render
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "ERROR: RENDER_API_KEY and RENDER_SERVICE_ID must be set as GitHub Secrets."
            echo "See the comments in this workflow step for instructions on where to find them."
            exit 1
          fi
          python3 .github/scripts/sync_render_env.py | curl -sSf -X PUT \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/env-vars" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d @-
          echo "Environment variables synced to Render successfully"
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          # ── Required ──────────────────────────────────────────────────────────────
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          JWT_KEY: ${{ secrets.JWT_KEY }}
          BACKEND_API_URL: ${{ secrets.BACKEND_API_URL }}
          ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          # ── Optional: Redis caching (app works without it) ────────────────────────
          REDIS_URL: ${{ secrets.REDIS_URL }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          # ── Optional: Google OAuth ────────────────────────────────────────────────
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          # ── Optional: Microsoft OAuth ─────────────────────────────────────────────
          MICROSOFT_CLIENT_ID: ${{ secrets.MICROSOFT_CLIENT_ID }}
          MICROSOFT_CLIENT_SECRET: ${{ secrets.MICROSOFT_CLIENT_SECRET }}
          # ── Optional: Stripe payments ─────────────────────────────────────────────
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          # ── Optional: PayPal payments ─────────────────────────────────────────────
          PAYPAL_CLIENT_ID: ${{ secrets.PAYPAL_CLIENT_ID }}
          PAYPAL_CLIENT_SECRET: ${{ secrets.PAYPAL_CLIENT_SECRET }}
          # ── Optional: M-Pesa payments ─────────────────────────────────────────────
          MPESA_CONSUMER_KEY: ${{ secrets.MPESA_CONSUMER_KEY }}
          MPESA_CONSUMER_SECRET: ${{ secrets.MPESA_CONSUMER_SECRET }}
          MPESA_CALLBACK_URL: ${{ secrets.MPESA_CALLBACK_URL }}
          # ── Optional: Cloudinary file storage ────────────────────────────────────
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
      - name: Deploy to Render
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK" ]; then
            echo "ERROR: RENDER_DEPLOY_HOOK is not set as a GitHub Secret."
            echo "Go to Render Dashboard → Your Service → Settings → Deploy Hooks → Create Deploy Hook"
            echo "Then add it as RENDER_DEPLOY_HOOK in repository Settings > Secrets and variables > Actions."
            exit 1
          fi
          curl -sSf -X POST "$RENDER_DEPLOY_HOOK"
          echo "Deployment triggered successfully"
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
      - name: Deployment Status
        run: |
          echo "Backend deployment status:"
          echo "- Environment variables synced from GitHub Secrets to Render"
          echo "- Deployment triggered via RENDER_DEPLOY_HOOK"
          echo "- All backend secrets are managed exclusively via GitHub Secrets"

  # Job 7: Deploy Frontend to Cloudflare Pages
  deploy-frontend:
    name: Deploy Frontend to Cloudflare Pages
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [security, test, build, deploy-worker]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install Frontend dependencies
        run: cd frontend && npm ci
      # Build with environment variables from GitHub Secrets
      - name: Build Frontend with Environment Variables
        run: cd frontend && npm run build
        env:
          # Frontend environment variables (injected at build time)
          VITE_BACKEND_URL: ${{ secrets.VITE_BACKEND_URL }}
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: "frontend"
          command: pages deploy dist --project-name=rest-shop-frontend --branch=main --commit-dirty=true

  # Job 7: CodeQL Analysis
  codeql:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
