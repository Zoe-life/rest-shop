# Cloudflare Workers Configuration
name = "rest-shop-api"
main = "src/worker.js"

# IMPORTANT: Bundle Size Notice
# This application uses Mongoose + Express which creates a ~2 MB bundle.
# Cloudflare Free Tier limit: 1 MB | Paid Tier limit: 10 MB
# See BUNDLE_SIZE_ANALYSIS.md for details and options.
# Current bundle: ~2 MB (minified) - REQUIRES PAID PLAN

# Compatibility flags
compatibility_date = "2026-01-20"
compatibility_flags = [ "nodejs_compat" ]

find_additional_modules = true

# Account details (will be overridden by secrets in CI/CD)
workers_dev = true


# Environment variables (non-sensitive)
[vars]
NODE_ENV = "production"
PORT = "3001"

# Add non-sensitive URLs here
FRONTEND_URL = "https://rest-shop.pages.dev"


# Service bindings
[[kv_namespaces]]
binding = "CACHE"
id = "2b52b610274c4a078262f796b01bb7ec"  # Replace with: wrangler kv:namespace create "CACHE"

# Durable Objects (for MongoDB connection pooling)
[[durable_objects.bindings]]
name = "DB_CONNECTION"
class_name = "DatabaseConnection"

# Build configuration
# Note: Minification is enabled via --minify flag in deploy command (wrangler.toml minify field is deprecated in v4)
[build]
command = "npm run build"

# This tells the Wrangler to treat HTML files as plain text
[[rules]]
type = "Text"
globs = ["**/*.html"]
fallthrough = true

# Migrations
[[migrations]]
tag = "v2"
new_sqlite_classes = ["DatabaseConnection"]
